# ==============================================================================
# Azure DevOps Pipeline - Djoppie Inventory DEV Environment
# ==============================================================================
#
# This pipeline provides complete CI/CD for Djoppie Inventory:
# - Infrastructure deployment (Bicep)
# - Backend API build and deployment (ASP.NET Core)
# - Frontend SPA build and deployment (React + Vite)
# - Database migrations (Entity Framework Core)
#
# Prerequisites:
# 1. Azure Resource Manager service connection named 'AzureServiceConnection'
# 2. Pipeline variables configured (see setup-azure-devops-variables.ps1)
# 3. Entra ID app registrations created (run setup-entra-apps.ps1)
#
# ==============================================================================

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/**
      - .azuredevops/README.md

pr:
  branches:
    include:
      - main
      - develop

variables:
  # Variable Groups (contains secrets)
  - group: 'Djoppie-Inventory-Dev'

  # Build Configuration
  - name: buildConfiguration
    value: 'Release'
  - name: dotnetSdkVersion
    value: '8.x'
  - name: nodeVersion
    value: '20.x'

  # Azure Configuration
  - name: azureServiceConnection
    value: 'AzureServiceConnection'
  - name: resourceGroupName
    value: 'rg-djoppie-inventory-dev'
  - name: location
    value: 'westeurope'

  # Application Names
  - name: backendAppServiceName
    value: 'app-djoppie-inventory-dev-api'
  - name: frontendStaticWebAppName
    value: 'swa-djoppie-inventory-dev-ui'

  # Paths
  - name: backendPath
    value: 'src/backend'
  - name: frontendPath
    value: 'src/frontend'
  - name: infraPath
    value: 'infra'

  # Build Artifacts
  - name: backendArtifactName
    value: 'backend-drop'
  - name: frontendArtifactName
    value: 'frontend-drop'
  - name: infraArtifactName
    value: 'infra-drop'

stages:
  # ============================================================================
  # STAGE 1: BUILD & TEST
  # ============================================================================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      # Backend Build
      - job: BuildBackend
        displayName: 'Build Backend API'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              packageType: 'sdk'
              version: $(dotnetSdkVersion)

          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet packages'
            inputs:
              command: 'restore'
              projects: '$(backendPath)/**/*.csproj'

          - task: DotNetCoreCLI@2
            displayName: 'Build Backend'
            inputs:
              command: 'build'
              projects: '$(backendPath)/**/*.csproj'
              arguments: '--configuration $(buildConfiguration) --no-restore'

          - task: DotNetCoreCLI@2
            displayName: 'Run Tests'
            inputs:
              command: 'test'
              projects: '$(backendPath)/**/*Tests.csproj'
              arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage"'

          - task: DotNetCoreCLI@2
            displayName: 'Publish Backend'
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: '$(backendPath)/DjoppieInventory.API/DjoppieInventory.API.csproj'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/backend --no-build'
              zipAfterPublish: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Backend Artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend'
              ArtifactName: $(backendArtifactName)

      # Frontend Build
      - job: BuildFrontend
        displayName: 'Build Frontend SPA'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - script: |
              cd $(frontendPath)
              npm ci
            displayName: 'Install npm dependencies'

          - script: |
              cd $(frontendPath)
              npm run lint
            displayName: 'Run Linter'
            continueOnError: true

          - script: |
              cd $(frontendPath)
              npm run test -- --run
            displayName: 'Run Tests'
            continueOnError: true

          - script: |
              cd $(frontendPath)

              # Create production .env file
              echo "VITE_API_URL=https://$(backendAppServiceName).azurewebsites.net" > .env.production
              echo "VITE_ENTRA_CLIENT_ID=$(ENTRA_FRONTEND_CLIENT_ID)" >> .env.production
              echo "VITE_ENTRA_TENANT_ID=$(ENTRA_TENANT_ID)" >> .env.production
              echo "VITE_ENTRA_REDIRECT_URI=https://$(frontendStaticWebAppName).azurestaticapps.net" >> .env.production
              echo "VITE_ENTRA_AUTHORITY=https://login.microsoftonline.com/$(ENTRA_TENANT_ID)" >> .env.production
              echo "VITE_ENTRA_API_SCOPE=api://$(ENTRA_BACKEND_CLIENT_ID)/access_as_user" >> .env.production

              npm run build
            displayName: 'Build Frontend'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Frontend Artifact'
            inputs:
              PathtoPublish: '$(frontendPath)/dist'
              ArtifactName: $(frontendArtifactName)

      # Infrastructure Preparation
      - job: PrepareInfra
        displayName: 'Prepare Infrastructure'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: CopyFiles@2
            displayName: 'Copy Bicep files'
            inputs:
              SourceFolder: '$(infraPath)'
              Contents: |
                **/*.bicep
                **/*.json
              TargetFolder: '$(Build.ArtifactStagingDirectory)/infra'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Infrastructure Artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/infra'
              ArtifactName: $(infraArtifactName)

  # ============================================================================
  # STAGE 2: DEPLOY INFRASTRUCTURE
  # ============================================================================
  - stage: DeployInfrastructure
    displayName: 'Deploy Infrastructure'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployInfra
        displayName: 'Deploy Azure Resources'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  displayName: 'Download Infrastructure Artifacts'
                  inputs:
                    buildType: 'current'
                    artifactName: 'infra-drop'
                    downloadPath: '$(Pipeline.Workspace)'

                - task: AzureCLI@2
                  displayName: 'Deploy Bicep Template'
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying infrastructure to Azure..."
                      echo "Artifact location: $(Pipeline.Workspace)/infra-drop"
                      ls -la $(Pipeline.Workspace)/infra-drop || echo "Artifact not found"

                      # Deploy at subscription scope
                      az deployment sub create \
                        --name "djoppie-dev-$(Build.BuildId)" \
                        --location $(location) \
                        --template-file $(Pipeline.Workspace)/infra-drop/bicep/main.dev.bicep \
                        --parameters \
                          environment=dev \
                          location=$(location) \
                          sqlAdminUsername=$(SQL_ADMIN_USERNAME) \
                          sqlAdminPassword=$(SQL_ADMIN_PASSWORD) \
                          entraTenantId=$(ENTRA_TENANT_ID) \
                          entraBackendClientId=$(ENTRA_BACKEND_CLIENT_ID) \
                          entraBackendClientSecret=$(ENTRA_BACKEND_CLIENT_SECRET) \
                          entraFrontendClientId=$(ENTRA_FRONTEND_CLIENT_ID) \
                        --output json > deployment-output.json

                      echo "Infrastructure deployment completed"
                      cat deployment-output.json

                - task: AzureCLI@2
                  name: GetOutputs
                  displayName: 'Get Deployment Outputs'
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Extracting deployment outputs..."

                      # Get the latest deployment
                      DEPLOYMENT_NAME="djoppie-dev-$(Build.BuildId)"

                      # Extract outputs
                      APP_SERVICE_NAME=$(az deployment sub show \
                        --name $DEPLOYMENT_NAME \
                        --query 'properties.outputs.appServiceName.value' \
                        -o tsv)

                      APP_SERVICE_URL=$(az deployment sub show \
                        --name $DEPLOYMENT_NAME \
                        --query 'properties.outputs.appServiceUrl.value' \
                        -o tsv)

                      STATIC_WEB_APP_NAME=$(az deployment sub show \
                        --name $DEPLOYMENT_NAME \
                        --query 'properties.outputs.staticWebAppName.value' \
                        -o tsv)

                      STATIC_WEB_APP_API_KEY=$(az deployment sub show \
                        --name $DEPLOYMENT_NAME \
                        --query 'properties.outputs.staticWebAppApiKey.value' \
                        -o tsv)

                      echo "##vso[task.setvariable variable=AppServiceName;isOutput=true]$APP_SERVICE_NAME"
                      echo "##vso[task.setvariable variable=AppServiceUrl;isOutput=true]$APP_SERVICE_URL"
                      echo "##vso[task.setvariable variable=StaticWebAppName;isOutput=true]$STATIC_WEB_APP_NAME"
                      echo "##vso[task.setvariable variable=StaticWebAppApiKey;isOutput=true;issecret=true]$STATIC_WEB_APP_API_KEY"

                      echo "App Service Name: $APP_SERVICE_NAME"
                      echo "App Service URL: $APP_SERVICE_URL"
                      echo "Static Web App Name: $STATIC_WEB_APP_NAME"
                      echo "Static Web App API Key: [REDACTED]"

  # ============================================================================
  # STAGE 3: DEPLOY BACKEND
  # ============================================================================
  - stage: DeployBackend
    displayName: 'Deploy Backend API'
    dependsOn: DeployInfrastructure
    condition: succeeded()
    jobs:
      - deployment: DeployBackendAPI
        displayName: 'Deploy to App Service'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  displayName: 'Download Backend Artifacts'
                  inputs:
                    buildType: 'current'
                    artifactName: 'backend-drop'
                    downloadPath: '$(Pipeline.Workspace)'

                - task: AzureCLI@2
                  name: GetAppServiceName
                  displayName: 'Get App Service Name'
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Find the App Service in the resource group (starts with 'app-' and contains 'api')
                      APP_SERVICE_NAME=$(az webapp list \
                        --resource-group $(resourceGroupName) \
                        --query "[?starts_with(name, 'app-') && contains(name, 'api')].name | [0]" \
                        -o tsv)

                      if [ -z "$APP_SERVICE_NAME" ]; then
                        echo "##[error]No App Service found in resource group $(resourceGroupName)"
                        exit 1
                      fi

                      echo "Found App Service: $APP_SERVICE_NAME"
                      echo "##vso[task.setvariable variable=appServiceName]$APP_SERVICE_NAME"

                - task: AzureWebApp@1
                  displayName: 'Deploy Backend to App Service'
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    appType: 'webApp'
                    appName: '$(appServiceName)'
                    package: '$(Pipeline.Workspace)/backend-drop/**/*.zip'
                    deploymentMethod: 'zipDeploy'

                - task: AzureCLI@2
                  displayName: 'Run Database Migrations'
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Database migrations will be applied on application startup"
                      echo "Verifying API health..."

                      # Wait for app to start
                      sleep 30

                      # Check health endpoint
                      HEALTH_URL="https://$(backendAppServiceName).azurewebsites.net/health"
                      echo "Checking: $HEALTH_URL"

                      curl -f $HEALTH_URL || echo "Health check failed - app may still be starting"

  # ============================================================================
  # STAGE 4: DEPLOY FRONTEND
  # ============================================================================
  - stage: DeployFrontend
    displayName: 'Deploy Frontend SPA'
    dependsOn:
      - DeployBackend
      - DeployInfrastructure
      - Build
    condition: succeeded()
    jobs:
      - deployment: DeployFrontendSPA
        displayName: 'Deploy to Static Web App'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  displayName: 'Checkout source code'

                - task: NodeTool@0
                  displayName: 'Install Node.js'
                  inputs:
                    versionSpec: $(nodeVersion)

                - task: AzureCLI@2
                  name: RebuildFrontend
                  displayName: 'Rebuild Frontend with Production URLs'
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Building frontend with production configuration..."

                      # Get actual resource names from infrastructure outputs
                      DEPLOYMENT_NAME="djoppie-dev-$(Build.BuildId)"

                      APP_SERVICE_URL=$(az deployment sub show \
                        --name $DEPLOYMENT_NAME \
                        --query 'properties.outputs.appServiceUrl.value' \
                        -o tsv)

                      STATIC_WEB_APP_URL=$(az deployment sub show \
                        --name $DEPLOYMENT_NAME \
                        --query 'properties.outputs.staticWebAppUrl.value' \
                        -o tsv)

                      echo "Backend API URL: $APP_SERVICE_URL"
                      echo "Frontend URL: $STATIC_WEB_APP_URL"

                      # Navigate to frontend directory
                      cd $(frontendPath)

                      # Install dependencies
                      npm ci

                      # Create production .env file with actual URLs
                      echo "VITE_API_URL=${APP_SERVICE_URL}/api" > .env.production
                      echo "VITE_ENTRA_CLIENT_ID=$(ENTRA_FRONTEND_CLIENT_ID)" >> .env.production
                      echo "VITE_ENTRA_TENANT_ID=$(ENTRA_TENANT_ID)" >> .env.production
                      echo "VITE_ENTRA_REDIRECT_URI=${STATIC_WEB_APP_URL}" >> .env.production
                      echo "VITE_ENTRA_AUTHORITY=https://login.microsoftonline.com/$(ENTRA_TENANT_ID)" >> .env.production
                      echo "VITE_ENTRA_API_SCOPE=api://$(ENTRA_BACKEND_CLIENT_ID)/access_as_user" >> .env.production

                      # Build frontend
                      npm run build

                      echo "Frontend build completed"

                - task: AzureCLI@2
                  name: GetStaticWebAppToken
                  displayName: 'Get Static Web App Deployment Token'
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Getting Static Web App deployment token..."

                      # Get deployment outputs
                      DEPLOYMENT_NAME="djoppie-dev-$(Build.BuildId)"

                      STATIC_WEB_APP_API_KEY=$(az deployment sub show \
                        --name $DEPLOYMENT_NAME \
                        --query 'properties.outputs.staticWebAppApiKey.value' \
                        -o tsv)

                      if [ -z "$STATIC_WEB_APP_API_KEY" ]; then
                        echo "##[error]Failed to get Static Web App API key from deployment outputs"
                        exit 1
                      fi

                      echo "Static Web App API key retrieved successfully"
                      echo "##vso[task.setvariable variable=staticWebAppToken;issecret=true]$STATIC_WEB_APP_API_KEY"

                - task: AzureStaticWebApp@0
                  displayName: 'Deploy Frontend to Static Web App'
                  inputs:
                    azure_static_web_apps_api_token: $(staticWebAppToken)
                    app_location: '$(frontendPath)/dist'
                    skip_app_build: true
                    skip_api_build: true

                - task: AzureCLI@2
                  displayName: 'Update Backend CORS with Frontend URL'
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Updating backend CORS configuration..."

                      DEPLOYMENT_NAME="djoppie-dev-$(Build.BuildId)"

                      STATIC_WEB_APP_URL=$(az deployment sub show \
                        --name $DEPLOYMENT_NAME \
                        --query 'properties.outputs.staticWebAppUrl.value' \
                        -o tsv)

                      APP_SERVICE_NAME=$(az webapp list \
                        --resource-group $(resourceGroupName) \
                        --query "[?starts_with(name, 'app-') && contains(name, 'api')].name | [0]" \
                        -o tsv)

                      echo "Setting CORS for $APP_SERVICE_NAME to allow $STATIC_WEB_APP_URL"

                      # Update app settings (used by ASP.NET Core CORS middleware)
                      az webapp config appsettings set \
                        --resource-group $(resourceGroupName) \
                        --name $APP_SERVICE_NAME \
                        --settings "Frontend__AllowedOrigins__0=$STATIC_WEB_APP_URL"

                      # Update Azure-level CORS (handles preflight before app code)
                      az webapp cors add \
                        --resource-group $(resourceGroupName) \
                        --name $APP_SERVICE_NAME \
                        --allowed-origins "$STATIC_WEB_APP_URL"

                      echo "Backend CORS updated successfully"

  # ============================================================================
  # STAGE 5: SMOKE TESTS
  # ============================================================================
  - stage: SmokeTests
    displayName: 'Smoke Tests'
    dependsOn:
      - DeployFrontend
      - DeployInfrastructure
    condition: succeeded()
    jobs:
      - job: RunSmokeTests
        displayName: 'Run Smoke Tests'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: AzureCLI@2
            name: GetResourceUrls
            displayName: 'Get Deployed Resource URLs'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Getting deployed resource URLs from deployment outputs..."

                # Get deployment outputs
                DEPLOYMENT_NAME="djoppie-dev-$(Build.BuildId)"

                APP_SERVICE_URL=$(az deployment sub show \
                  --name $DEPLOYMENT_NAME \
                  --query 'properties.outputs.appServiceUrl.value' \
                  -o tsv)

                STATIC_WEB_APP_URL=$(az deployment sub show \
                  --name $DEPLOYMENT_NAME \
                  --query 'properties.outputs.staticWebAppUrl.value' \
                  -o tsv)

                echo "Backend API URL: $APP_SERVICE_URL"
                echo "Frontend URL: $STATIC_WEB_APP_URL"

                echo "##vso[task.setvariable variable=backendUrl]$APP_SERVICE_URL"
                echo "##vso[task.setvariable variable=frontendUrl]$STATIC_WEB_APP_URL"

          - script: |
              echo "Running smoke tests..."

              # Test Backend API
              BACKEND_URL="$(backendUrl)"
              echo "Testing Backend: $BACKEND_URL"

              # Health check (note: /health requires auth, so 401 is expected)
              echo "Checking backend availability..."
              HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/health")

              if [ "$HEALTH_STATUS" = "401" ] || [ "$HEALTH_STATUS" = "200" ]; then
                echo "✓ Backend is running (HTTP $HEALTH_STATUS)"
              else
                echo "✗ Backend health check failed (HTTP $HEALTH_STATUS)"
                exit 1
              fi

              # Test Frontend
              FRONTEND_URL="$(frontendUrl)"
              echo "Testing Frontend: $FRONTEND_URL"

              # Check if frontend is accessible
              FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL")

              if [ "$FRONTEND_STATUS" = "200" ]; then
                echo "✓ Frontend is accessible (HTTP $FRONTEND_STATUS)"
              else
                echo "✗ Frontend check failed (HTTP $FRONTEND_STATUS)"
                exit 1
              fi

              echo ""
              echo "=========================================="
              echo "All smoke tests passed!"
              echo "=========================================="
              echo "Backend:  $BACKEND_URL"
              echo "Frontend: $FRONTEND_URL"
              echo "=========================================="
            displayName: 'Run Smoke Tests'
